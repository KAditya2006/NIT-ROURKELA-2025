<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin Withdraw Panel | InternLearn</title>
  <link rel="stylesheet" href="admin-withdraw.css">
</head>
<body>

  <h1>🧾 Withdraw Requests</h1>
  <div id="reqList"></div>

  <!-- EmailJS Library -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, getDoc } 
      from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

    // 🔥 Firebase Config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "YOUR_MSG_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ✉️ Initialize EmailJS
    emailjs.init("YOUR_PUBLIC_KEY"); // Replace with your EmailJS Public Key

    async function loadRequests() {
      const reqRef = collection(db, "withdrawRequests");
      const snapshot = await getDocs(reqRef);
      const list = document.getElementById("reqList");
      list.innerHTML = "";

      snapshot.forEach(async (docSnap) => {
        const data = docSnap.data();
        if (data.status === "pending") {
          list.innerHTML += `
            <div class="request">
              <div>
                <b>${data.email}</b><br>
                ₹${data.amount} — ${data.method}<br>
                ${data.upi}<br>
                <small>${data.date}</small>
              </div>
              <div class="btns">
                <button class="approve" onclick="approve('${docSnap.id}', ${data.amount}, '${data.email}')">Approve</button>
                <button class="reject" onclick="reject('${docSnap.id}')">Reject</button>
              </div>
            </div>
          `;
        }
      });
    }

    // ✅ APPROVE FUNCTION
    window.approve = async (id, amount, email) => {
      const txnId = "TXN" + Math.floor(Math.random() * 1000000000);
      const requestRef = doc(db, "withdrawRequests", id);
      await updateDoc(requestRef, { 
        status: "approved",
        txnId: txnId,
        paidAt: new Date().toLocaleString()
      });

      // Deduct XP from user
      const userRef = doc(db, "leaderboard", email);
      const userSnap = await getDoc(userRef);
      if (userSnap.exists()) {
        const xp = userSnap.data().xp || 0;
        await updateDoc(userRef, { xp: xp - (amount * 100) });
      }

      // 💌 Send Email to user
      emailjs.send("YOUR_SERVICE_ID", "YOUR_TEMPLATE_ID", {
        email: email,
        amount: amount,
        txnId: txnId
      }).then(() => {
        alert("✅ Request Approved & Email Sent!");
      }).catch(err => console.error(err));

      loadRequests();
    };

    // ❌ REJECT FUNCTION
    window.reject = async (id) => {
      const requestRef = doc(db, "withdrawRequests", id);
      await updateDoc(requestRef, { status: "rejected" });
      alert("❌ Request Rejected!");
      loadRequests();
    };

    loadRequests();
  </script>

</body>
</html>
